# 医院预约与诊断系统  
## 后端实现说明（Flask）

---

## 1. 后端技术概述

本系统后端基于 **Flask** 框架实现，采用 **MVC 风格的分层结构**，将数据模型、业务路由和公共工具模块进行解耦，便于维护与扩展。

### 技术栈
- Flask（Web 框架）
- Flask-SQLAlchemy（ORM）
- JWT（用户身份认证）
- SQLite / MySQL（可替换）
- RESTful API 风格

---

## 2. 项目目录结构说明

```

hospital/3.backend
├── app.py
├── config.py
├── extensions.py
├── models/
│   ├── user.py
│   ├── doctors.py
│   ├── department.py
│   ├── drug.py
│   ├── record.py
│   ├── record_drug.py
│   └── **init**.py
├── routes/
│   ├── auth.py
│   ├── doctor.py
│   ├── drug.py
│   ├── record.py
│   └── **init**.py
├── utils/
│   ├── decorators.py
│   ├── jwt.py
│   └── **init**.py
├── README.md
├── pyproject.toml
├── uv.lock
└── test.sh

````

---

## 3. 各模块职责说明

### 3.1 app.py（应用入口）

- 创建 Flask 应用实例
- 加载配置
- 初始化数据库等扩展
- 注册各个 Blueprint（路由模块）

---

### 3.2 config.py（配置文件）

- 数据库连接配置
- JWT 密钥
- Debug / 开发环境配置

---

### 3.3 extensions.py（扩展初始化）

- 初始化 SQLAlchemy 实例
- 避免循环依赖
- 为模型和路由统一提供数据库对象

---

### 3.4 models（数据模型层）

`models` 目录用于定义数据库表结构，每个文件对应一张表：

| 文件 | 对应表 | 说明 |
|---|---|---|
| user.py | users | 系统用户（学生 / 医生 / 管理员） |
| doctors.py | doctors | 医生扩展信息 |
| department.py | departments | 科室信息 |
| drug.py | drugs | 药品信息 |
| record.py | records | 预约 / 就诊记录 |
| record_drug.py | record_drugs | 就诊记录与药品的关联表 |

- 使用 SQLAlchemy ORM
- 表之间通过外键建立关系
- 模型只负责“数据结构”，不包含业务逻辑

---

### 3.5 routes（路由 / 业务逻辑层）

`routes` 目录用于实现具体的 API 接口逻辑：

| 文件 | 功能 |
|---|---|
| auth.py | 登录、注册、认证相关接口 |
| doctor.py | 医生相关接口 |
| drug.py | 药品管理接口 |
| record.py | 预约、诊断、历史记录接口 |

- 使用 Flask Blueprint 进行模块化拆分
- 每个接口对应一个具体业务功能

---

### 3.6 utils（工具模块）

#### decorators.py
- 实现 `@login_required` 装饰器
- 统一处理 Token 校验
- 将用户信息注入到 `request.user`

#### jwt.py
- 负责 JWT 的生成与解析
- 封装底层 JWT 操作逻辑

---

## 4. 接口实现示例说明（records_history）

下面以 **获取历史就诊记录接口** 为例，说明后端业务逻辑的实现方式。

---

### 4.1 接口定义

```python
@bp.route("/records_history", methods=["GET"])
@login_required
def records_history():
````

* 使用 Blueprint 注册路由
* 通过 `@login_required` 装饰器保证接口必须登录访问

---

### 4.2 用户身份获取

```python
uid = request.user["uid"]
role = request.user["role"]
```

* `request.user` 由 `login_required` 装饰器注入
* 包含当前用户的：

  * 用户 ID
  * 用户角色（patient / doctor）

---

### 4.3 根据角色查询不同数据

```python
if role == "patient":
    records = (
        Record.query.filter(Record.patient_id == uid)
        .order_by(Record.id.desc())
        .all()
    )
else:
    records = (
        Record.query.filter(Record.doctor_id == uid)
        .order_by(Record.id.desc())
        .all()
    )
```

* **学生用户**：查询自己作为患者的就诊记录
* **医生用户**：查询自己处理过的诊断记录
* 通过角色分支实现同一接口的多角色复用

---

### 4.4 组装业务数据

```python
for r in records:
```

对每一条就诊记录，查询其关联信息：

#### 1️⃣ 查询医生信息

```python
doctor = User.query.get(r.doctor_id)
doctor_user = User.query.get(doctor.id) if doctor else None
```

* 根据记录中的 `doctor_id` 查询医生用户
* 用于返回医生姓名

---

#### 2️⃣ 查询科室信息

```python
dept = Department.query.get(r.department_id)
```

* 获取就诊科室名称

---

#### 3️⃣ 查询用药信息（多对多）

```python
record_drugs = (
    db.session.query(RecordDrug, Drug)
    .join(Drug, RecordDrug.drug_id == Drug.id)
    .filter(RecordDrug.record_id == r.id)
    .all()
)
```

* 使用关联表 `record_drugs`
* 联合查询药品信息
* 体现数据库设计中的多对多关系

---

### 4.5 返回统一 JSON 结构

```python
return jsonify({"status": True, "data": result})
```

* 返回前端所需的完整业务数据
* 保证接口风格统一，便于前端解析

